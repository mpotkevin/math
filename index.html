<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數學練習題產生器</title>
    <!-- 引入 React, Tailwind CSS 與 Lucide 圖標庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
        }

        .a4-page {
            width: 21cm;
            height: 29.7cm;
            background: white;
            margin: 2rem auto;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        @media print {
            body { background: white !important; margin: 0 !important; padding: 0 !important; }
            .no-print { display: none !important; }
            .a4-page {
                width: 21cm;
                height: 29.7cm;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                page-break-after: always;
                page-break-inside: avoid;
            }
        }

        .font-mono { font-family: 'Courier New', Courier, monospace; }
        .tabular-nums { font-variant-numeric: tabular-nums; }
        
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // 圖標組件封裝
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [view, setView] = useState('settings'); // 'settings' or 'preview'
            const [settings, setSettings] = useState({
                numDigits: '2',       // 1. 數字位數
                allowCarry: 'random', // 2. 進位 / 借位
                numOperands: 3,       // 3. 數字連算數量
                numQuestions: 20,     // 4. 總題目數
                columns: 2,           // 5. 欄位數量
                fontSize: 24,         // 6. 字體大小
                numCopies: 1,         // 7. 列印份數
                operation: 'mixed'    
            });

            const [worksheets, setWorksheets] = useState([]);

            const getRandDigits = (mode) => {
                switch (mode) {
                    case '1': return 1;
                    case '2': return 2;
                    case '3': return 3;
                    case 'mixed12': return Math.random() > 0.5 ? 1 : 2;
                    case 'mixed23': return Math.random() > 0.5 ? 2 : 3;
                    default: return 2;
                }
            };

            const generateNumber = (digits) => {
                const min = Math.pow(10, digits - 1);
                const max = Math.pow(10, digits) - 1;
                return Math.floor(Math.random() * (max - min + 1)) + min;
            };

            const createOneWorksheetData = () => {
                const questions = [];
                let attempts = 0;
                while (questions.length < settings.numQuestions && attempts < 5000) {
                    attempts++;
                    const operands = [];
                    const operators = [];
                    operands.push(generateNumber(getRandDigits(settings.numDigits)));
                    for (let i = 1; i < settings.numOperands; i++) {
                        const op = Math.random() > 0.5 ? 'add' : 'sub';
                        operators.push(op === 'add' ? '+' : '-');
                        operands.push(generateNumber(getRandDigits(settings.numDigits)));
                    }
                    let currentVal = operands[0];
                    let isValidResult = true;
                    for (let i = 0; i < operators.length; i++) {
                        if (operators[i] === '+') currentVal += operands[i+1];
                        else currentVal -= operands[i+1];
                        if (currentVal < 0) { isValidResult = false; break; }
                    }
                    if (!isValidResult) continue;

                    let hasCarryOrBorrow = false;
                    if (settings.allowCarry !== 'random') {
                        let tempVal = operands[0];
                        for (let i = 0; i < operators.length; i++) {
                            const a = tempVal;
                            const b = operands[i+1];
                            const op = operators[i];
                            const aStr = a.toString().split('').reverse();
                            const bStr = b.toString().split('').reverse();
                            const maxLen = Math.max(aStr.length, bStr.length);
                            if (op === '+') {
                                for (let j = 0; j < maxLen; j++) {
                                    if (parseInt(aStr[j] || 0) + parseInt(bStr[j] || 0) >= 10) { hasCarryOrBorrow = true; break; }
                                }
                                tempVal += b;
                            } else {
                                for (let j = 0; j < maxLen; j++) {
                                    if (parseInt(aStr[j] || 0) < parseInt(bStr[j] || 0)) { hasCarryOrBorrow = true; break; }
                                }
                                tempVal -= b;
                            }
                            if (hasCarryOrBorrow) break;
                        }
                        if (settings.allowCarry === 'no' && hasCarryOrBorrow) continue;
                        if (settings.allowCarry === 'yes' && !hasCarryOrBorrow) continue;
                    }
                    questions.push({ operands, operators, ans: currentVal });
                }
                return questions;
            };

            const paginateQuestions = (questions) => {
                const rowHeight = settings.fontSize * 2.0; 
                // A4 內容高度限制在 1060px，縮小行高係數至 2.0 以善用空間
                const rowsPerPage = Math.max(1, Math.floor(1060 / rowHeight));
                const questionsPerPage = rowsPerPage * settings.columns;
                const pages = [];
                for (let i = 0; i < questions.length; i += questionsPerPage) {
                    pages.push(questions.slice(i, i + questionsPerPage));
                }
                return pages;
            };

            const generateAllWorksheets = () => {
                const all = [];
                for (let c = 0; c < settings.numCopies; c++) {
                    const questions = createOneWorksheetData();
                    all.push({
                        id: `sheet-${Date.now()}-${c}`,
                        copyIndex: c + 1,
                        pages: paginateQuestions(questions),
                        allQuestions: questions 
                    });
                }
                setWorksheets(all);
            };

            useEffect(() => {
                generateAllWorksheets();
            }, [settings]);

            const handlePrint = () => {
                // 某些瀏覽器需要先 focus 視窗
                window.focus();
                // 延遲一點點時間讓 DOM 完全穩定後開啟列印視窗
                setTimeout(() => {
                    window.print();
                }, 300);
            };

            return (
                <div className="min-h-screen">
                    {/* 設定面板視圖 */}
                    {view === 'settings' && (
                        <div className="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl p-8 mb-10 no-print border border-slate-200 mt-12">
                            <div className="flex items-center gap-4 mb-8 border-b pb-6 text-slate-800">
                                <div className="bg-blue-600 p-3 rounded-2xl text-white shadow-lg">
                                    <Icon name="settings" size={28} />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-black tracking-tight">數學練習題產生器</h1>
                                    <p className="text-slate-500 text-sm font-medium">調整下方參數，即時產生不重複的練習題目</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8 text-slate-700">
                                <label className="block">
                                    <span className="text-sm font-bold mb-2 flex items-center gap-2"><Icon name="binary" className="text-blue-500" /> 1. 數字位數</span>
                                    <select 
                                        className="w-full rounded-xl border-2 border-slate-100 bg-slate-50 p-3 focus:border-blue-500 focus:bg-white transition-all outline-none"
                                        value={settings.numDigits}
                                        onChange={(e) => setSettings({...settings, numDigits: e.target.value})}
                                    >
                                        <option value="1">個位數</option>
                                        <option value="2">雙位數</option>
                                        <option value="3">三位數</option>
                                        <option value="mixed12">混合 (個位 + 雙位)</option>
                                        <option value="mixed23">混合 (雙位 + 三位)</option>
                                    </select>
                                </label>

                                <label className="block">
                                    <span className="text-sm font-bold mb-2 flex items-center gap-2"><Icon name="refresh-cw" className="text-blue-500" /> 2. 進位 / 借位</span>
                                    <select 
                                        className="w-full rounded-xl border-2 border-slate-100 bg-slate-50 p-3 focus:border-blue-500 focus:bg-white transition-all outline-none"
                                        value={settings.allowCarry}
                                        onChange={(e) => setSettings({...settings, allowCarry: e.target.value})}
                                    >
                                        <option value="random">隨機 (不限)</option>
                                        <option value="no">禁止進位 / 借位</option>
                                        <option value="yes">必須有進位 / 借位</option>
                                    </select>
                                </label>

                                <label className="block">
                                    <span className="text-sm font-bold mb-2 flex items-center gap-2"><Icon name="plus-circle" className="text-blue-500" /> 3. 數字連算數量</span>
                                    <input 
                                        type="number" min="2" max="10"
                                        className="w-full rounded-xl border-2 border-slate-100 bg-slate-50 p-3 focus:border-blue-500 focus:bg-white transition-all outline-none font-bold text-center"
                                        value={settings.numOperands}
                                        onChange={(e) => setSettings({...settings, numOperands: parseInt(e.target.value) || 2})}
                                    />
                                </label>

                                <label className="block">
                                    <span className="text-sm font-bold mb-2 flex items-center gap-2"><Icon name="file-text" className="text-blue-500" /> 4. 總題目數</span>
                                    <input 
                                        type="number" min="1" max="500"
                                        className="w-full rounded-xl border-2 border-slate-100 bg-slate-50 p-3 focus:border-blue-500 focus:bg-white transition-all outline-none font-bold text-center"
                                        value={settings.numQuestions}
                                        onChange={(e) => setSettings({...settings, numQuestions: parseInt(e.target.value) || 1})}
                                    />
                                </label>

                                <label className="block">
                                    <span className="text-sm font-bold mb-2 flex items-center gap-2"><Icon name="columns" className="text-blue-500" /> 5. 欄位數量</span>
                                    <div className="grid grid-cols-3 gap-2 mt-1">
                                        {[1, 2, 3].map(n => (
                                            <button 
                                                key={n}
                                                onClick={() => setSettings({...settings, columns: n})}
                                                className={`py-2 rounded-xl font-bold border-2 transition-all ${settings.columns === n ? 'bg-blue-600 border-blue-600 text-white shadow-md' : 'bg-white border-slate-100 text-slate-400 hover:border-blue-200'}`}
                                            >
                                                {n} 欄
                                            </button>
                                        ))}
                                    </div>
                                </label>

                                <label className="block">
                                    <span className="text-sm font-bold mb-2 flex items-center gap-2"><Icon name="type" className="text-blue-500" /> 6. 字體大小: {settings.fontSize}px</span>
                                    <div className="flex items-center gap-4 mt-2">
                                        <input 
                                            type="range" min="16" max="64" 
                                            className="flex-1 h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                            value={settings.fontSize}
                                            onChange={(e) => setSettings({...settings, fontSize: parseInt(e.target.value)})}
                                        />
                                        <span className="w-8 font-bold text-blue-600 text-center">{settings.fontSize}</span>
                                    </div>
                                </label>

                                <label className="block md:col-span-2">
                                    <span className="text-sm font-bold mb-2 flex items-center gap-2"><Icon name="copy" className="text-blue-500" /> 7. 列印份數 (生成多份不同題目)</span>
                                    <input 
                                        type="number" min="1" max="100"
                                        className="w-full rounded-2xl border-2 border-slate-100 bg-slate-50 p-4 focus:border-blue-500 focus:bg-white transition-all outline-none font-black text-blue-600 text-center text-2xl shadow-inner"
                                        value={settings.numCopies}
                                        onChange={(e) => setSettings({...settings, numCopies: parseInt(e.target.value) || 1})}
                                    />
                                </label>
                            </div>

                            <div className="mt-12 flex flex-col items-center">
                                <button 
                                    onClick={() => setView('preview')}
                                    className="group relative bg-blue-600 hover:bg-blue-700 text-white px-20 py-5 rounded-2xl font-black text-xl transition-all shadow-xl shadow-blue-100 active:scale-95 flex items-center gap-3"
                                >
                                    <Icon name="eye" size={24} /> 顯示 A4 預覽與下載
                                </button>
                                <p className="text-slate-400 text-xs mt-4">預覽模式將自動按照 A4 格式進行智慧分頁</p>
                            </div>
                        </div>
                    )}

                    {/* A4 預覽視圖 */}
                    {view === 'preview' && (
                        <div className="relative">
                            {/* 預覽導航欄 */}
                            <div className="sticky top-0 z-50 w-full bg-white/90 backdrop-blur-md border-b border-slate-200 p-4 shadow-sm no-print">
                                <div className="max-w-6xl mx-auto flex justify-between items-center">
                                    <button 
                                        onClick={() => setView('settings')}
                                        className="flex items-center gap-2 px-6 py-2 rounded-xl text-slate-600 font-bold hover:bg-slate-100 transition-all border border-slate-200"
                                    >
                                        <Icon name="arrow-left" size={20} /> 返回修改設定
                                    </button>
                                    <div className="flex flex-col items-center gap-1">
                                        <div className="flex items-center gap-4">
                                            <span className="text-slate-500 text-sm font-medium">
                                                正在預覽 <span className="text-blue-600 font-bold">{settings.numCopies}</span> 份內容
                                            </span>
                                            <button 
                                                onClick={handlePrint}
                                                className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-2 rounded-xl font-black transition-all shadow-lg active:scale-95 flex items-center gap-2"
                                            >
                                                <Icon name="printer" size={20} /> 列印 / 下載 PDF
                                            </button>
                                        </div>
                                        <span className="text-[10px] text-emerald-600 font-bold">提示：請在列印視窗中選擇「另存為 PDF」</span>
                                    </div>
                                </div>
                            </div>

                            {/* 預覽內容 */}
                            <div className="pb-20">
                                {worksheets.map((sheet) => (
                                    <React.Fragment key={sheet.id}>
                                        {/* 題目分頁 */}
                                        {sheet.pages.map((pageQuestions, pIdx) => (
                                            <div key={`${sheet.id}-p-${pIdx}`} className="a4-page overflow-hidden flex flex-col print:break-after-page shadow-2xl mb-10 print:mb-0 print:shadow-none">
                                                <div className="p-[0.8cm] md:p-[1cm] flex-grow">
                                                    <div className="flex justify-between items-end border-b-2 border-black pb-3 mb-8 text-black">
                                                        <div>
                                                            <h2 className="text-3xl font-black tracking-tighter uppercase leading-none">數學練習題 (#{sheet.copyIndex})</h2>
                                                            <div className="text-[10px] text-slate-400 font-bold mt-1 tracking-widest uppercase">
                                                                Page {pIdx + 1} / {sheet.pages.length}
                                                            </div>
                                                        </div>
                                                        <div className="w-48 text-[12px] font-bold space-y-1.5">
                                                            <div className="border-b border-slate-300 flex justify-between">姓名：<span className="w-32"></span></div>
                                                            <div className="border-b border-slate-300 flex justify-between">日期：<span className="w-32"></span></div>
                                                        </div>
                                                    </div>

                                                    <div 
                                                        className="grid gap-x-12 gap-y-4 text-black" 
                                                        style={{ 
                                                            gridTemplateColumns: `repeat(${settings.columns}, 1fr)`,
                                                            fontSize: `${settings.fontSize}px`,
                                                            lineHeight: '1.2'
                                                        }}
                                                    >
                                                        {pageQuestions.map((q, qIdx) => {
                                                            const globalIdx = sheet.pages.slice(0, pIdx).reduce((acc, p) => acc + p.length, 0) + qIdx + 1;
                                                            return (
                                                                <div key={qIdx} className="flex items-baseline overflow-hidden">
                                                                    <span className="w-10 text-slate-300 font-mono text-sm font-bold shrink-0">{globalIdx}.</span>
                                                                    <div className="flex-1 font-mono flex flex-wrap items-center gap-x-1 gap-y-1 whitespace-nowrap">
                                                                        {q.operands.map((num, nIdx) => (
                                                                            <React.Fragment key={nIdx}>
                                                                                <span className="tabular-nums">{num}</span>
                                                                                {nIdx < q.operators.length && (
                                                                                    <span className="text-blue-500 font-bold px-0.5">{q.operators[nIdx]}</span>
                                                                                )}
                                                                            </React.Fragment>
                                                                        ))}
                                                                        <span className="font-bold">=</span>
                                                                        <div className="border-b-2 border-slate-200 flex-grow min-w-[50px] h-[1.1em]"></div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                                <div className="p-4 text-center text-[9px] text-slate-300 border-t border-slate-50 italic tracking-widest">
                                                    練習是進步的唯一途徑 • Set #{sheet.copyIndex} - Page {pIdx + 1}
                                                </div>
                                            </div>
                                        ))}

                                        {/* 解答頁 */}
                                        <div className="a4-page overflow-hidden flex flex-col print:break-after-page print:bg-white bg-slate-50 shadow-inner">
                                            <div className="p-[1.5cm] flex-grow">
                                                <div className="flex items-center gap-4 mb-8 pb-3 border-b-2 border-slate-300">
                                                    <div className="bg-emerald-500 p-1.5 rounded-lg text-white">
                                                        <Icon name="check-circle-2" size={20} />
                                                    </div>
                                                    <h3 className="text-xl font-bold text-slate-800 tracking-tight">標準解答卷 (Set #{sheet.copyIndex})</h3>
                                                </div>
                                                <div className="grid grid-cols-5 gap-4">
                                                    {sheet.allQuestions.map((q, qIdx) => (
                                                        <div key={qIdx} className="bg-white p-3 rounded-xl border border-slate-200 flex flex-col items-center shadow-sm">
                                                            <span className="text-[10px] text-slate-400 font-bold mb-1 italic text-center w-full">Q{qIdx + 1}</span>
                                                            <span className="text-xl font-black text-blue-700 font-mono tabular-nums tracking-tighter text-center">{q.ans}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="p-6 text-center text-[10px] text-slate-400 border-t border-slate-100 font-bold tracking-widest uppercase">
                                                Answer Key for Worksheet Set #{sheet.copyIndex}
                                            </div>
                                        </div>
                                    </React.Fragment>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
